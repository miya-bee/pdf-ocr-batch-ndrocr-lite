# pdf-ocr-batch-ndrocr-lite

NDLOCR-Lite を用いて、OCR未処理の PDF・画像にテキスト層を一括付加する Python 製バッチツールです。

## 概要

大量の PDF や画像ファイルの中から、**既にテキスト層があるものはスキップ**し、**OCR未処理のものだけ**に OCR を実行して、検索可能なファイルとして保存することを目的としたツールです。

スキャンPDFや紙資料の画像化データを後からまとめて検索可能にしたい場合に向いています。

本ツールは **NDLOCR-Lite** を利用し、日本語文書の OCR を行います。

---

## 主な特徴

- OCR未処理の PDF を自動判定
- OCR未処理の PDF・画像のみを対象に一括処理
- PDF / 画像の両方に対応
- 出力先を入力元と同じフォルダに保存可能
- 出力ファイル名の競合時は連番で保存
- CSVログ出力に対応
- 元PDFを保持したまま、OCR結果を不可視テキストとして重畳可能
- テキスト層の三重化問題を修正済み

---

## 想定用途

- 過去に作成したスキャンPDFの一部に OCR が付いていない
- フォルダ内の大量ファイルを一つずつ確認するのが現実的でない
- 既にOCR済みのファイルを再処理せず、未処理のものだけを対象にしたい
- 後から全文検索できるようにしたい

---

## 対応入力形式

- PDF
- PNG
- JPG / JPEG
- BMP
- TIFF / TIF
- WEBP

※ 実際の対応形式は実装・環境により変わる場合があります。

---

## 動作方針

### PDF
- テキスト層の有無を判定
- テキスト層がない PDF のみ OCR を実行
- 元PDFのページ内容は保持
- OCR結果のみを不可視テキストとして重畳

### 画像
- OCR を実行
- 検索可能な PDF として出力

---

## 現在の安定版

- **v62**
  - 元PDFを保持
  - OCR結果だけを不可視テキストとして重畳
  - テキスト層が重なってコピペ時に同文が複数回出る問題を修正済み

### 参考
- **v60**
  - 安全版
  - 元PDFを画像化して再PDF化する方式
  - 三重化回避のための退避版

---

## 必要環境

- Windows
- Python 3.10 系推奨
- NDLOCR-Lite が利用可能な環境

---

## 依存関係

本ツールの実行には、少なくとも以下が必要です。

- Python
- NDLOCR-Lite
- PDF処理ライブラリ
- 画像処理ライブラリ
- フォント処理に必要なライブラリ

実際の依存関係は、同梱のソースコードまたは requirements 相当の情報を参照してください。

---

## NDLOCR-Lite について

このツールは OCR エンジンとして **NDLOCR-Lite** を利用します。  
NDLOCR-Lite 本体の導入と動作確認は、事前に各自で行ってください。

本ツール側では、NDLOCR-Lite の実行コマンドを呼び出す形で OCR を実行します。

---

## 使い方

1. NDLOCR-Lite を利用可能な状態にする
2. 本ツールを起動する
3. 単一ファイルまたは対象フォルダを指定する
4. OCR 実行を開始する
5. 出力先に OCR 済み PDF が保存される

---

## 出力仕様

- 出力先は、入力ファイルと同じフォルダに保存可能
- 既に同名の OCR 出力がある場合は、連番を付けて保存
- 処理ログは CSV として保存可能

### 出力ファイル名の例

- `sample.pdf` → `sample_ocr.pdf`
- 同名ファイルが存在する場合  
  `sample_ocr_001.pdf`  
  `sample_ocr_002.pdf`

---

## ログ出力

処理結果は CSV ログとして保存できます。  
ログには、たとえば以下のような情報が含まれます。

- 対象ファイル
- OCR 実行の有無
- スキップ理由
- エラー有無
- 出力先
- 実行時刻

---

## スキップ条件

以下のようなファイルは、設定や判定結果に応じてスキップされます。

- 既に十分なテキスト層が存在すると判定された PDF
- 出力対象外のファイル
- 名前条件により除外されたファイル
- OCR 実行に失敗したファイル

---

## このツールの利点

- OCR済みファイルの再処理を避けられる
- 未OCRファイルだけを効率的に検索可能PDFへ変換できる
- 元PDFを保持しつつ検索性を付与できる
- バッチ処理向けで、大量ファイルの後追いOCRに向いている

---

## 注意事項

- OCR精度は原稿状態や画像品質に依存します
- 傾き、かすれ、低解像度、強いノイズがある資料では認識精度が落ちる場合があります
- 元PDFの構造によっては、ビューアごとの表示差が出る可能性があります
- OCR結果の正確性を保証するものではありません
- 重要資料へ適用する前に、必ず少数ファイルで動作確認してください

---

## 既知の経緯

過去の改良で、ファイルサイズ増加対策として  
**元PDFを保持し、OCR結果だけを重ねる方式**  
へ寄せた際に、PDF構造によってはテキスト層が重なり、コピー時に同じ文章が複数回出る問題が発生しました。

v62 では、ページごとの内容ストリームの扱いを見直すことで、この問題を修正しています。

---

## 向いている文書

- 会議資料
- 議事録
- スキャンした書類
- 冊子の一部抜粋
- 紙資料をPDF化したアーカイブ

---

## 向いていないケース

- 完全なレイアウト再現が最優先の用途
- OCR結果をそのまま正本扱いする用途
- 高度なレイアウト解析や構造化抽出が必須の用途

---



---

## ライセンス

ライセンスは今後整理予定です。  
公開時には、利用条件に合わせて適切なライセンスを設定してください。

---

## 免責

本ツールを利用したことによる損害・不利益について、作者は責任を負いません。  
必ず事前にテストデータで動作確認したうえで利用してください。

---

## 作者メモ

このリポジトリは、  
**「OCR未処理のPDF・画像だけを効率的に検索可能化する」**  
ことを目的として継続改善している実用ツールです。

特に、以下の両立を重視しています。

- 既存PDFをできるだけ保持すること
- OCRテキスト層を安定して付加すること
